services:
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_USER: ${COLONIES_DB_USER}
      POSTGRES_PASSWORD: ${COLONIES_DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data
      TZ: ${TZ}
      TS_TUNE_MAX_CONNS: "1000"
    volumes:
      - timescaledb_data:/var/lib/postgresql/data

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: ${MINIO_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    volumes:
      - minio_data:/var/lib/minio/data
    command: minio server /var/lib/minio/data --console-address :9001
    ports:
      - "9000:9000"
      - "9001:9001"

  minio-setup:
    image: minio/mc
    depends_on:
      - minio
    environment:
      AWS_S3_ENDPOINT: minio:9000
      AWS_S3_ACCESSKEY: RrXN2vcLeHjBptG8a3Ay
      AWS_S3_SECRETKEY: ivwLB0Luqomq65nNVmoo8fTBgxXgNvqYGC50VQN6
      AWS_S3_REGION_KEY: ""
      AWS_S3_BUCKET: colonies-prod
      AWS_S3_TLS: "false"
      AWS_S3_SKIPVERIFY: "false"
      MINIO_USER: ${MINIO_USER}
      MINIO_PASSWORD: ${MINIO_PASSWORD}
    entrypoint: >
      /bin/sh -c "
      echo 'Executing: /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_USER} ${MINIO_PASSWORD}';
      until (/usr/bin/mc alias set myminio http://minio:9000 ${MINIO_USER} ${MINIO_PASSWORD}); do echo 'Waiting for MinIO...'; sleep 3; done;
      echo 'MinIO is ready. Setting up...';
      echo 'Executing: /usr/bin/mc admin user add myminio ${AWS_S3_ACCESSKEY} ${AWS_S3_SECRETKEY}';
      /usr/bin/mc admin user add myminio ${AWS_S3_ACCESSKEY} ${AWS_S3_SECRETKEY};
      echo 'Executing: /usr/bin/mc admin policy attach myminio readwrite --user=${AWS_S3_ACCESSKEY}';
      /usr/bin/mc admin policy attach myminio readwrite --user=${AWS_S3_ACCESSKEY};
      echo 'Executing: /usr/bin/mc mb myminio/${AWS_S3_BUCKET}';
      /usr/bin/mc mb myminio/${AWS_S3_BUCKET};
      echo 'MinIO setup completed.';
      "

  colonies-server:
    image: colonyos/colonies:latest
    depends_on:
      - timescaledb
    environment:
      COLONIES_SERVER_BACKENDS: ${COLONIES_SERVER_BACKENDS}
      COLONIES_SERVER_HTTP_TLS: ${COLONIES_SERVER_HTTP_TLS}
      COLONIES_SERVER_HTTP_PORT: ${COLONIES_SERVER_HTTP_PORT}
      COLONIES_SERVER_GRPC_PORT: ${COLONIES_SERVER_GRPC_PORT}
      COLONIES_SERVER_GRPC_INSECURE: ${COLONIES_SERVER_GRPC_INSECURE}
      COLONIES_SERVER_GRPC_TLS_CERT: ${COLONIES_SERVER_GRPC_TLS_CERT:-}
      COLONIES_SERVER_GRPC_TLS_KEY: ${COLONIES_SERVER_GRPC_TLS_KEY:-}
      COLONIES_SERVER_LIBP2P_PORT: ${COLONIES_SERVER_LIBP2P_PORT}
      COLONIES_SERVER_LIBP2P_IDENTITY: ${COLONIES_SERVER_LIBP2P_IDENTITY}
      COLONIES_SERVER_COAP_PORT: ${COLONIES_SERVER_COAP_PORT}
      COLONIES_SERVER_LIBP2P_BOOTSTRAP_PEERS: ${COLONIES_SERVER_LIBP2P_BOOTSTRAP_PEERS}
      COLONIES_SERVER_LIBP2P_ANNOUNCE_ADDRS: ${COLONIES_SERVER_LIBP2P_ANNOUNCE_ADDRS:-}
      COLONIES_SERVER_ID: ${COLONIES_SERVER_ID}
      COLONIES_SERVER_HOST: ${COLONIES_SERVER_HOST}
      COLONIES_DB_HOST: timescaledb
      COLONIES_DB_PORT: 5432
      COLONIES_DB_USER: ${COLONIES_DB_USER}
      COLONIES_DB_PASSWORD: ${COLONIES_DB_PASSWORD}
      COLONIES_DB_TIMESCALEDB: "true"
      COLONIES_TLSCERT: "/run/secrets/tls/tls.crt"
      COLONIES_TLSKEY: "/run/secrets/tls/tls.key"
      COLONIES_VERBOSE: "true"
      COLONIES_SERVER_PROFILER: "false"
      COLONIES_SERVER_PROFILER_PORT: "6060"
      COLONIES_ALLOW_EXECUTOR_REREGISTER: ${COLONIES_ALLOW_EXECUTOR_REREGISTER}
      COLONIES_CRON_CHECKER_PERIOD: "1000"
      COLONIES_GENERATOR_CHECKER_PERIOD: "500"
      COLONIES_EXCLUSIVE_ASSIGN: "true"
      COLONIES_RETENTION: "false"
      COLONIES_RETENTION_POLICY: "604800" # 60 seconds * 60 * 24 * 7 = 604800 (1 week)
      TZ: ${TZ}
    volumes:
      - colonies_etcd:/var/colonies/etcd
    ports:
      - "${COLONIES_SERVER_HTTP_PORT}:${COLONIES_SERVER_HTTP_PORT}"
      - "${COLONIES_SERVER_GRPC_PORT}:${COLONIES_SERVER_GRPC_PORT}"
      - "${COLONIES_SERVER_LIBP2P_PORT}:${COLONIES_SERVER_LIBP2P_PORT}"
      - "50001:50001/udp"  # QUIC port (LibP2P port + 1)
      - "${COLONIES_SERVER_COAP_PORT}:${COLONIES_SERVER_COAP_PORT}/udp"
    command: sh -c "colonies server start --initdb --port ${COLONIES_SERVER_HTTP_PORT} --relayport 25100 --etcdname server1 --etcdhost colonies-server --etcdclientport 23100 --etcdpeerport 24100 --initial-cluster server1=colonies-server:24100:25100:${COLONIES_SERVER_HTTP_PORT} --etcddatadir /var/colonies/etcd --insecure"

  colonies-setup:
    image: colonyos/colonies:v1.9.1
    depends_on:
      - colonies-server
    environment:
      COLONIES_CLIENT_BACKENDS: "http"
      # HTTP client config (inside docker, always use colonies-server as host)
      COLONIES_CLIENT_HTTP_HOST: "colonies-server"
      COLONIES_CLIENT_HTTP_PORT: ${COLONIES_SERVER_HTTP_PORT}
      COLONIES_CLIENT_HTTP_INSECURE: "true"
      # gRPC client config (inside docker, always use colonies-server as host)
      COLONIES_CLIENT_GRPC_HOST: "colonies-server"
      COLONIES_CLIENT_GRPC_PORT: ${COLONIES_SERVER_GRPC_PORT}
      COLONIES_CLIENT_GRPC_INSECURE: "true"
      # LibP2P client config
      COLONIES_CLIENT_LIBP2P_HOST: "/dns/colonies-server/tcp/${COLONIES_SERVER_LIBP2P_PORT}/p2p/12D3KooWSBx1mxbu7rJ8AMsSGHDhG8GRhwqHSVnHPbhZypPLFjgK"
      COLONIES_CLIENT_LIBP2P_BOOTSTRAP_PEERS: ${COLONIES_CLIENT_LIBP2P_BOOTSTRAP_PEERS}
      # Backward compatibility (hardcode colonies-server for docker containers)
      COLONIES_SERVER_HOST: "colonies-server"
      COLONIES_SERVER_PORT: ${COLONIES_SERVER_HTTP_PORT}
      COLONIES_SERVER_TLS: "false"
      COLONIES_TLS: "false"
      # Server and auth config
      COLONIES_SERVER_ID: ${COLONIES_SERVER_ID}
      COLONIES_SERVER_PRVKEY: ${COLONIES_SERVER_PRVKEY}
      COLONIES_PRVKEY: ${COLONIES_PRVKEY}
      COLONIES_VERBOSE: "true"
      COLONIES_COLONY_NAME: ${COLONIES_COLONY_NAME}
      COLONIES_COLONY_ID: ${COLONIES_COLONY_ID}
      COLONIES_COLONY_PRVKEY: ${COLONIES_COLONY_PRVKEY}
      COLONIES_ID: ${COLONIES_ID}
      TZ: ${TZ}
    volumes:
      - ./deployment/catalog:/catalog:ro
    entrypoint: >
      /bin/sh -c "
      echo 'Executing: colonies colony add --name ${COLONIES_COLONY_NAME} --colonyid ${COLONIES_COLONY_ID}';
      until (colonies server status); do echo 'Waiting for Colonies server...'; sleep 3; done;
      colonies colony add --name ${COLONIES_COLONY_NAME} --colonyid ${COLONIES_COLONY_ID};
      echo 'Executing: colonies user add --name=myuser --email= --phone= --userid=${COLONIES_ID}';
      colonies user add --name='myuser' --email='' --phone='' --userid=${COLONIES_ID};
      echo 'Adding blueprint definition...';
      colonies blueprint definition add --spec /catalog/executor-deployment-definition.json;
      echo 'Waiting for docker-reconciler to be ready...';
      sleep 5;
      echo 'Adding docker-executor deployment with 1 replica...';
      colonies blueprint add --spec /catalog/docker-executor-deployment.json;
      "

  docker-reconciler:
    image: colonyos/docker-reconciler:v1.0.0
    container_name: docker-reconciler
    restart: unless-stopped
    depends_on:
      - colonies-server
      - colonies-setup
    environment:
      COLONIES_CLIENT_BACKENDS: ${COLONIES_CLIENT_BACKENDS}
      # HTTP client config (inside docker, always use colonies-server as host)
      COLONIES_CLIENT_HTTP_HOST: "colonies-server"
      COLONIES_CLIENT_HTTP_PORT: ${COLONIES_SERVER_HTTP_PORT}
      COLONIES_CLIENT_HTTP_INSECURE: "true"
      # gRPC client config (inside docker, always use colonies-server as host)
      COLONIES_CLIENT_GRPC_HOST: "colonies-server"
      COLONIES_CLIENT_GRPC_PORT: ${COLONIES_SERVER_GRPC_PORT}
      COLONIES_CLIENT_GRPC_INSECURE: "true"
      # LibP2P client config
      COLONIES_CLIENT_LIBP2P_HOST: "/dns/colonies-server/tcp/${COLONIES_SERVER_LIBP2P_PORT}/p2p/12D3KooWSBx1mxbu7rJ8AMsSGHDhG8GRhwqHSVnHPbhZypPLFjgK"
      COLONIES_CLIENT_LIBP2P_BOOTSTRAP_PEERS: ${COLONIES_CLIENT_LIBP2P_BOOTSTRAP_PEERS}
      # Backward compatibility (hardcode colonies-server for docker containers)
      COLONIES_SERVER_HOST: "colonies-server"
      COLONIES_SERVER_PORT: ${COLONIES_SERVER_HTTP_PORT}
      COLONIES_SERVER_TLS: "false"
      COLONIES_TLS: "false"
      # Auth config
      COLONIES_COLONY_NAME: ${COLONIES_COLONY_NAME}
      COLONIES_COLONY_PRVKEY: ${COLONIES_COLONY_PRVKEY}
      COLONIES_EXECUTOR_TYPE: "docker-reconciler"
      COLONIES_EXECUTOR_NAME: "local-docker-node-reconciler"
      COLONIES_INSECURE: "true"
      # Node config - Fixed node name to prevent new nodes on restart
      COLONIES_NODE_NAME: "local-docker-node"
      COLONIES_NODE_LOCATION: "local"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for Colonies server to be ready...';
      until wget -q -O /dev/null http://colonies-server:50080/health 2>/dev/null; do
        echo 'Server not ready, retrying in 2 seconds...';
        sleep 2;
      done;
      echo 'Server is ready!';
      echo \"Starting docker-reconciler with name: $$COLONIES_EXECUTOR_NAME\";
      docker-reconciler start -v
      "

  # docker-executor is now managed by docker-reconciler
  # See executors/docker-reconciler/examples/docker-executor-deployment.json
  # To deploy: colonies blueprint add --spec executors/docker-reconciler/examples/docker-executor-deployment.json

volumes:
  timescaledb_data:
  minio_data:
  colonies_etcd:
